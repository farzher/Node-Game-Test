<canvas id="canvas"></canvas>

<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.10/socket.io.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>

<script>
(function() {
	// shim layer with setTimeout fallback
    window.requestAnimFrame = (function() {
      return  window.requestAnimationFrame       || 
              window.webkitRequestAnimationFrame || 
              window.mozRequestAnimationFrame    || 
              window.oRequestAnimationFrame      || 
              window.msRequestAnimationFrame     || 
              function( callback ){
                window.setTimeout(callback, 1000 / 60);
              };
    })();

	//connection logic
	var socket = io.connect('http://71.246.26.9:25565');
	var settings = {};
	var id;
	socket.on('id', function(data) {
		id = data;
	});
	socket.on('settings', function(data) {
		settings = data;
		startGame();
	});
	var state = {p: [], b: []};
	socket.on('state', function(data) {
		_.each(data.p, function(value, key) {
			state.p[key] = _.extend(state.p[key] || {}, value);
		});
		state.b = data.b;
	});

	function Player(socket) {
		var player = this;
		player.id = id;
		player.socket = socket;
		player.keyState = {};

		//player does all of its own event management
		//this setup doesn't spam key events while held down
		$(window).on('keydown', function(e) {
			var keyCode = e.which;
			var lastState = player.keyState[keyCode];
			var currentState = player.keyState[keyCode] = true;
			if(lastState !== currentState) {
				socket.emit('keydown', keyCode);
			}
		});
		$(window).on('keyup', function(e) {
			var keyCode = e.which;
			var lastState = player.keyState[keyCode];
			var currentState = player.keyState[keyCode] = false;
			if(lastState !== currentState) {
				socket.emit('keyup', keyCode);
			}
		});
	}

	// when we get our settings, start rendering the game
	function startGame() {
		//we're done loading, let's go
		var player = new Player(socket);

		// drawing
		var canvas = document.getElementById('canvas');
		var c = canvas.getContext('2d');
		var w = settings.width;
	    var h = settings.height;
		c.canvas.width  = w;
		c.canvas.height = h;

		// update loop
		(function updateLoop() {
	    	requestAnimFrame(updateLoop);
	    	//


		})();

	    // render loop
	    (function renderLoop() {
	    	requestAnimFrame(renderLoop);
	    	//

	    	if(!state) return;
			//state is loaded

	    	//redraw a white background
			c.fillStyle = "rgb(255, 200, 200)";
			c.fillRect(0, 0, w, h);

			//draw the players
			_.each(state.p, function(p) {
				if(player.id == p.id) {
					c.fillStyle = "rgb(0,0,200)";
				} else {
					c.fillStyle = "rgb(200,0,0)";
				}
				c.fillRect (p.x, p.y, settings.playerHitbox.x, settings.playerHitbox.y);
			});

			//draw the bullets
			_.each(state.b, function(b) {
				if(player.id == b.playerId) {
					c.fillStyle = 'rgb(30, 30, 230)';
				} else {
					c.fillStyle = 'rgb(230, 30, 30)';
				}
				
				c.fillRect(b.x, b.y, settings.bulletHitbox.x, settings.bulletHitbox.y);
			});
		})();
	}
})();
</script>
