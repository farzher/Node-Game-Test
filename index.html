<canvas id="canvas"></canvas>
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.10/socket.io.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
<script>
// load in all them images
var Assets = {
	'idle'          : './assets/p2/idle.png',
	'block_middle'  : './assets/p2/block_middle.png',
	'block_low'     : './assets/p2/block_low.png',
	'attack_middle' : './assets/p2/attack_middle.png',
	'attack_low'    : './assets/p2/attack_low.png',
	'attack_high'   : './assets/p2/attack_high.png',
	'down'          : './assets/p2/down.png',
	'recovering'    : './assets/p2/recovering.png',
};
_.each(Assets, function(v, k) {
	var img = new Image();
	img.src = v;
	Assets[k] = img;
});


(function() {
	// shim layer with setTimeout fallback
    window.requestAnimFrame = (function() {
      return  window.requestAnimationFrame       || 
              window.webkitRequestAnimationFrame || 
              window.mozRequestAnimationFrame    || 
              window.oRequestAnimationFrame      || 
              window.msRequestAnimationFrame     || 
              function( callback ){
                window.setTimeout(callback, 1000 / 60);
              };
    })();

	//connection logic
	var socket = io.connect('http://71.246.26.9:25565');
	var settings = {};
	var id;
	socket.on('id', function(data) {
		id = data;
	});
	socket.on('settings', function(data) {
		settings = data;
		startGame();
	});
	var state = {p: []};
	socket.on('state', function(data) {
		_.each(data.p, function(value, key) {
			state.p[key] = _.extend(state.p[key] || {}, value);
		});
	});

	function Player(socket) {
		var player = this;
		player.id = id;
		player.socket = socket;
		player.keyState = {};

		//player does all of its own event management
		//this setup doesn't spam key events while held down
		$(window).on('keydown', function(e) {
			var keyCode = e.which;
			var lastState = player.keyState[keyCode];
			var currentState = player.keyState[keyCode] = true;
			if(lastState !== currentState) {
				socket.emit('keydown', keyCode);
			}
		});
		$(window).on('keyup', function(e) {
			var keyCode = e.which;
			var lastState = player.keyState[keyCode];
			var currentState = player.keyState[keyCode] = false;
			if(lastState !== currentState) {
				socket.emit('keyup', keyCode);
			}
		});
	}

	// when we get our settings, start rendering the game
	function startGame() {
		//we're done loading, let's go
		var player = new Player(socket);

		// drawing
		var canvas = document.getElementById('canvas');
		var c = canvas.getContext('2d');
		var w = settings.width + 200;
	    var h = 250;
		c.canvas.width  = w;
		c.canvas.height = h;

		// update loop
		(function updateLoop() {
	    	requestAnimFrame(updateLoop);
	    	//


		})();

	    // render loop
	    (function renderLoop() {
	    	requestAnimFrame(renderLoop);
	    	//

	    	if(!state) return;
			//state is loaded

	    	//redraw a white background
			c.fillStyle = "rgb(255, 200, 200)";
			c.fillRect(0, 0, w, h);

			//draw the players
			_.each(state.p, function(p) {
				var scale = (p.num === 2) ? -1 : 1;
				var x = p.x + 100;
				var y = 100;
				if(scale === -1) {
					x *= -1;
					x -= settings.player.width;
				}

				c.save();
				c.scale(scale, 1);
				c.drawImage(Assets[p.sprite], x, y);
				c.restore();
			});
		})();
	}
})();
</script>
